<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../stylesheets/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    />
    <title>Todoアプリ</title>
  </head>
  <body>
    <!--
    <div class="container">
      
      ボタン1
    </div>
     コメントは複数行に
    またがってもかまいません。-->

    <script
      type="button"
      class="btn btn-primary mb-7"
      data-toggle="modal"
      data-target="#newtaskModal"
    >
      ボタン
    </script>
    <br /><br />

    <table class="table">
      <thead>
        <tr>
          <!--<th scope="col-1">状態</th>-->
          <th scope=>タスク名</th>
          <th scope=>期限</th>
          <th>カテゴリ名</th>
          <th>ステータス</th>
          <th scope=>ボタン1</th>
          <th scope=>ボタン2</th>
        </tr>
      </thead>
      <tbody id="get-task"></tbody>
    </table>

    <!-- newtaskModal -->
    
    <div
      class="modal fade"
      id="newtaskModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="newtaskModal"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4>
              <div class="modal-title" id="myModalLabel1">新規登録</div>
            </h4>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id ="create-form">
            <form>
              <div class="form-group">
                <label for="taskname">タスク名</label>
                <input
                  type="text"
                  class="form-control"
                  id="taskName"
                  name="taskName"
                />
              </div>
              <div class="form-group">
                <label for="deadline-day">締切日</label>
                <input
                  type="date"
                  class="form-control"
                  id="deadlineDay"
                  name="deadlineDay"
                />
              </div>
              <div class="form-group">
                <label for="category-id">カテゴリ</label>
                <select 
                  class="form-control"
                  id="categoryId"
                  name="categoryId"
                >
                  <option selected>カテゴリを選択</option>
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                </select>
              
            </form>
          </div>
         
          <div class="modal-footer">
            <button
              type="button" 
              class="btn btn-default" 
              data-dismiss="modal"
            >
              閉じる
            </button>
            <button 
              type="button" 
              class="btn btn-primary"
              id="NEWTASK"
              data-dismiss="modal"
              >追加</button>
          </div>

        </div>
      </div>
    </div>
  
    <!-- ↑newtaskModal↑ -->
    <!--↓changetaskModal↓ -->
    <div
      class="modal fade"
      id="change"
      tabindex="-1"
      role="dialog"
      aria-labelledby="change"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4>
              <div class="modal-title" id="update-modal">更新</div>
            </h4>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="update-form">
            <label>タスクの更新</label>
            <form>
              
              <input type="hidden" name="id" />
              <div class="form-group">
                <label for="taskname_up">タスク</label>
                <input class="form-control" type="text" id="TASKNAME" name="TASKNAME" />
              </div>
              <div class="form-group">
                <label for="deadline-day_up">日付</label>
                <input class="form-control" type="date" id="deadlineDay_up" name="deadlineDay_up" />
              </div>
              <div class="form-group">
                <label for="category-id_up">カテゴリ</label>
                <select class="form-control" id="CATEGORY" name="CATEGORY">
                  
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                </select>
              </div>

              <div class="form-group">
                <label for="status">ステータス</label>
                <select class="form-control" id = "STATUS" name="STATUS">
                  <option value="1">完了</option>
                  <option value="2">作業中</option>
                  <option value="3">未実施</option>
                </select>
              </div>
              <!--
              <button type="submit" class="btn btn-primary">Submit</button>
              -->
            </form>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              キャンセル
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="update-task"
              data-dismiss="modal"
            >
              更新
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <!--httpPost-->
    <script src="../javascripts/index.js"></script>

    <script>
      //newtask
      $("#NEWTASK").on("click", async function () {
        //idがNEWTASKのボタンをクリックしたらフォームからリクエストデータを取得するjQuery
        const requestData = {
          //create-form フォームのID name プッシュされる中身の名前
          TaskName: $("#create-form input[name=taskName]").val(),
          Deadline: $("#create-form input[name=deadlineDay]").val(),
          Category: $("#create-form select[name=categoryId]").val(),
        };
        const response = await httpPost(
          "//" + window.location.host + "/api/tasks",
          requestData
        );
      });
      //gettask
      $(async function () {
        const response = await httpGet(
          "//" + window.location.host + "/api/tasks"
        );
        console.log(response)
        const list = response.map((item) => {
          const date = new Date(item.deadline);
          const year = date.getFullYear();
          const month = ("0" + (date.getMonth() + 1)).slice(-2);
          const day = ("0" + date.getDate()).slice(-2);
          const deadlineVal = `${year}年${month}月${day}日`;
          return `
          <tr>
            <td>${item.task_name}</td>
            <td>${deadlineVal}</td>
            <td>${item.category_name}</td>
            <td>${item.task_status}</td>
            <td>
              <button
                class="btn btn-primary"
                id="update-button"
                data-toggle="modal"
                data-target="#change"
                data-id=${item.id}>
                更新
              </button>
            </td>
            <td>
              <button
              class="btn btn-primary"
              id="delete-button"
              data-id=${item.id}
              data-delete=${item.task_name}>
              削除
              </button>
            </td>
          </tr>`;
        });
        $("tbody#get-task").append(list);
      });
      //kousin
      $(document).on("click", "#update-button", async function () {
        $("#modal").show(); //モーダル勢はいらない
        const id = $(this).data("id");
        const response = await httpGet(
          "//" + window.location.host + `/api/tasks/${id}`
        );
        const date = new Date(response[0].deadline);
        const year = date.getFullYear();
        const month = ("0" + (date.getMonth() + 1)).slice(-2);
        const day = ("0" + date.getDate()).slice(-2);
        const deadlineVal = `${year}-${month}-${day}`;
        $("#update-form input[name=id]").val(response[0].id);
        $("#update-form input[name=TASKNAME]").val(response[0].task_name);
        $("#update-form input[name=deadlineDay_up]").val(deadlineVal);
        $("#update-form select[name=CATEGORY]").val(
          response[0].category_id
        );
        $("#update-form select[name=STATUS]").val(response[0].task_status);
      });
      
      $("#update-task").on("click", async function () {
        const id = $("#update-form input[name=id]").val();
        const requestData = {
          taskName: $("#update-form input[name=TASKNAME]").val(),
          deadline: $("#update-form input[name=deadlineDay_up]").val(),
          category: $("#update-form select[name=CATEGORY]").val(),
          status: $("#update-form select[name=STATUS]").val(),
        };
        const response = await httpUpdate(
          "//" + window.location.host + `/api/tasks/${id}`,
          requestData
        );
        window.location.reload();
      });

      $(document).on("click", "#delete-button", async function () {
        const taskName = $(this).data("delete");
        if (confirm(`下記の内容を削除します\n ${taskName}`)) {
          const id = $(this).data("id");
          const response = await httpDelete(
            "//" + window.location.host + `/api/tasks/${id}`
          );
          window.location.reload();
        }
      });
    </script>
  </body>
</html>
