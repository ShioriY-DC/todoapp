<!DOCTYPE html>
<html lang="ja">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../stylesheets/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    />
    <title>Todoアプリ</title>
  </head>
  <body>
    <!--
    <div class="container">
      
      ボタン1
    </div>
     コメントは複数行に
    またがってもかまいません。-->
    <header id="header">
      <a href="#"><h1>ToDoApp</h1></a>
      <nav>
        <td id="g-navi">
          <tr>
            <a href="howto.html"
              ><svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-info-circle"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
                />
                <path
                  d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"
                />
              </svg>
              使い方</a
            >
          </tr>
        </td>
      </nav>
    </header>
    <br />
    <br />

    <button
      class="btn btn-success"
      data-toggle="modal"
      data-target="#newtaskModal"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        fill="currentColor"
        class="bi bi-file-earmark-plus"
        viewBox="0 0 16 16"
      >
        <path
          d="M8 6.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V9.5H6a.5.5 0 0 1 0-1h1.5V7a.5.5 0 0 1 .5-.5z"
        />
        <path
          d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"
        />
      </svg>
      新規登録
    </button>
    <br /><br />

    <table class="table">
      <thead>
        <tr>
          <td class="stacate"></td>
          <td class="name"></td>
          <td class="time">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-alarm"
              viewBox="0 0 16 16"
            >
              <path
                d="M8.5 5.5a.5.5 0 0 0-1 0v3.362l-1.429 2.38a.5.5 0 1 0 .858.515l1.5-2.5A.5.5 0 0 0 8.5 9V5.5z"
              />
              <path
                d="M6.5 0a.5.5 0 0 0 0 1H7v1.07a7.001 7.001 0 0 0-3.273 12.474l-.602.602a.5.5 0 0 0 .707.708l.746-.746A6.97 6.97 0 0 0 8 16a6.97 6.97 0 0 0 3.422-.892l.746.746a.5.5 0 0 0 .707-.708l-.601-.602A7.001 7.001 0 0 0 9 2.07V1h.5a.5.5 0 0 0 0-1h-3zm1.038 3.018a6.093 6.093 0 0 1 .924 0 6 6 0 1 1-.924 0zM0 3.5c0 .753.333 1.429.86 1.887A8.035 8.035 0 0 1 4.387 1.86 2.5 2.5 0 0 0 0 3.5zM13.5 1c-.753 0-1.429.333-1.887.86a8.035 8.035 0 0 1 3.527 3.527A2.5 2.5 0 0 0 13.5 1z"
              />
            </svg>
          </td>

          <td class="button"></td>
        </tr>
      </thead>
      <tbody id="get-task"></tbody>
    </table>

    <!-- newtaskModal -->

    <div
      class="modal fade"
      id="newtaskModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="newtaskModal"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4>
              <div class="modal-title" id="myModalLabel1">新規登録</div>
            </h4>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="create-form">
            <form>
              <div class="form-group">
                <label for="taskname">タスク名</label>
                <input
                  type="text"
                  class="form-control"
                  id="taskName"
                  name="taskName"
                />
              </div>
              <div class="form-group">
                <label for="deadline-day">締切日</label>
                <input
                  type="date"
                  class="form-control"
                  id="deadlineDay"
                  name="deadlineDay"
                />
              </div>
              <div class="form-group">
                <label for="category-id">カテゴリ</label>
                <select class="form-control" id="categoryId" name="categoryId">
                  <option selected>カテゴリを選択</option>
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                </select>
              </div>
            </form>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              閉じる
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="NEWTASK"
              data-dismiss="modal"
            >
              追加
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ↑newtaskModal↑ -->
    <!--↓changetaskModal↓ -->
    <div
      class="modal fade"
      id="change"
      tabindex="-1"
      role="dialog"
      aria-labelledby="change"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4>
              <div class="modal-title" id="update-modal">更新</div>
            </h4>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="update-form">
            <label>タスクの更新</label>
            <form>
              <input type="hidden" name="id" />
              <div class="form-group">
                <label for="taskname_up">タスク</label>
                <input
                  class="form-control"
                  type="text"
                  id="TASKNAME"
                  name="TASKNAME"
                />
              </div>
              <div class="form-group">
                <label for="deadline-day_up">日付</label>
                <input
                  class="form-control"
                  type="date"
                  id="deadlineDay_up"
                  name="deadlineDay_up"
                />
              </div>
              <div class="form-group">
                <label for="category-id_up">カテゴリ</label>
                <select class="form-control" id="CATEGORY" name="CATEGORY">
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                </select>
              </div>

              <div class="form-group">
                <label for="status">ステータス</label>
                <select class="form-control" id="STATUS" name="STATUS">
                  <option value="1">完了</option>
                  <option value="2">作業中</option>
                  <option value="3">未実施</option>
                </select>
              </div>
              <!--
              <button type="submit" class="btn btn-primary">Submit</button>
              -->
            </form>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              キャンセル
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="update-task"
              data-dismiss="modal"
            >
              更新
            </button>
          </div>
        </div>
      </div>
    </div>
    <p id="page-top"><a href="#">Page Top</a></p>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>

    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <!--httpPost-->
    <script src="../javascripts/index.js"></script>

    <script>
      //newtask
      $("#NEWTASK").on("click", async function () {
        //idがNEWTASKのボタンをクリックしたらフォームからリクエストデータを取得するjQuery
        const requestData = {
          //create-form フォームのID name プッシュされる中身の名前
          TaskName: $("#create-form input[name=taskName]").val(),
          Deadline: $("#create-form input[name=deadlineDay]").val(),
          Category: $("#create-form select[name=categoryId]").val(),
        };
        const response = await httpPost(
          "//" + window.location.host + "/api/tasks",
          requestData
        );
        window.location.reload();
      });
      //gettask
      $(async function () {
        const response = await httpGet(
          "//" + window.location.host + "/api/tasks"
        );
        console.log(response);
        const list = response.map((item) => {
          const date = new Date(item.deadline);
          const year = date.getFullYear();
          const month = ("0" + (date.getMonth() + 1)).slice(-2);
          const day = ("0" + date.getDate()).slice(-2);
          const deadlineVal = `${year}年${month}月${day}日`;
          console.log(item);
          var sta = "0";
          var STA = "";
          if (item.task_status == 1) {
            var sta = "kan";
            var STA = `
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="25"
                height="25"
                fill="currentColor"
                class="bi bi-check2"
                viewBox="0 0 16 16"
              >
                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z" />
              </svg>
            `;
          } else if (item.task_status == 2) {
            var sta = "sagyo";
            var STA = `
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-person-workspace"
                viewBox="0 0 16 16"
              >
                <path d="M4 16s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H4Zm4-5.95a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" />
                <path d="M2 1a2 2 0 0 0-2 2v9.5A1.5 1.5 0 0 0 1.5 14h.653a5.373 5.373 0 0 1 1.066-2H1V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v9h-2.219c.554.654.89 1.373 1.066 2h.653a1.5 1.5 0 0 0 1.5-1.5V3a2 2 0 0 0-2-2H2Z" />
              </svg>
            `;
          } else {
            var sta = "mi";
          }
          console.log(sta);
          var cate = "0";

          if (item.category_id == 1) {
            var cate = `"sei"`;
          } else if (item.category_id == 2) {
            var cate = `"ben"`;
          } else if (item.category_id == 3) {
            var cate = `"shigo"`;
          } else {
            var cate = `"syu"`;
          }
          console.log(cate);
          return `
                <tr class=${sta}>
                  <td class=${cate}>${STA}</td>
                  <!--<td>${item.category_name}</td>-->
                  <td class="taskname">${item.task_name}</td>
                  <td>${deadlineVal}</td>
                  <!--<td>${item.task_status}</td>-->
                  <td>
                    <button
                      class="btn btn-primary btn-sm"
                      id="update-button"
                      data-toggle="modal"
                      data-target="#change"
                      data-id=${item.id}>
                      <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        width="16" 
                        height="16" 
                        fill="currentColor" 
                        class="bi bi-pencil-square" 
                        viewBox="0 0 16 16"
                      >
                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                      </svg>
                      更新
                    </button>
                  <!--</td>
                  <td>-->
                    <button
                      class="btn btn-danger btn-sm"
                      id="delete-button"
                      data-id=${item.id}
                      data-delete=${item.task_name}>
                      <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        width="16" height="16" fill="currentColor" 
                        class="bi bi-file-earmark-x" 
                        viewBox="0 0 16 16"
                        >
                        <path d="M6.854 7.146a.5.5 0 1 0-.708.708L7.293 9l-1.147 1.146a.5.5 0 0 0 .708.708L8 9.707l1.146 1.147a.5.5 0 0 0 .708-.708L8.707 9l1.147-1.146a.5.5 0 0 0-.708-.708L8 8.293 6.854 7.146z"/>
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                      </svg>
                      削除
                    </button>
                  </td>
                </tr>`;
        });
        $("tbody#get-task").append(list);
      });
      //kousin
      $(document).on("click", "#update-button", async function () {
        $("#modal").show(); //モーダル勢はいらない
        const id = $(this).data("id");
        const response = await httpGet(
          "//" + window.location.host + `/api/tasks/${id}`
        );
        const date = new Date(response[0].deadline);
        const year = date.getFullYear();
        const month = ("0" + (date.getMonth() + 1)).slice(-2);
        const day = ("0" + date.getDate()).slice(-2);
        const deadlineVal = `${year}-${month}-${day}`;
        $("#update-form input[name=id]").val(response[0].id);
        $("#update-form input[name=TASKNAME]").val(response[0].task_name);
        $("#update-form input[name=deadlineDay_up]").val(deadlineVal);
        $("#update-form select[name=CATEGORY]").val(response[0].category_id);
        $("#update-form select[name=STATUS]").val(response[0].task_status);
      });

      $("#update-task").on("click", async function () {
        const id = $("#update-form input[name=id]").val();
        const requestData = {
          taskName: $("#update-form input[name=TASKNAME]").val(),
          deadline: $("#update-form input[name=deadlineDay_up]").val(),
          category: $("#update-form select[name=CATEGORY]").val(),
          status: $("#update-form select[name=STATUS]").val(),
        };
        const response = await httpUpdate(
          "//" + window.location.host + `/api/tasks/${id}`,
          requestData
        );
        window.location.reload();
      });

      $(document).on("click", "#delete-button", async function () {
        const taskName = $(this).data("delete");
        if (confirm(`下記の内容を削除します\n ${taskName}`)) {
          const id = $(this).data("id");
          const response = await httpDelete(
            "//" + window.location.host + `/api/tasks/${id}`
          );
          window.location.reload();
        }
      });
    </script>
  </body>
</html>
